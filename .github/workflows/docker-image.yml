name: Temporary VPS

on:
  workflow_dispatch:

jobs:
  vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Install packages
      run: |
        sudo apt update
        sudo apt install -y python3 python3-pip php wget unzip
        pip3 install flask

    - name: Create user info
      run: |
        echo "USERNAME: sifodz" > info.txt
        echo "PASSWORD: sssddd333" >> info.txt

    - name: Create web terminal
      run: |
        cat << 'EOF' > app.py
        from flask import Flask, request
        import subprocess

        app = Flask(__name__)

        @app.route("/", methods=["GET", "POST"])
        def index():
            output = ""
            if request.method == "POST":
                cmd = request.form.get("cmd")
                try:
                    output = subprocess.check_output(
                        cmd, shell=True, stderr=subprocess.STDOUT, timeout=5
                    ).decode()
                except Exception as e:
                    output = str(e)
            return f"""
            <h2>Web VPS Terminal</h2>
            <form method="post">
            <input name="cmd" style="width:80%" placeholder="ls, python3, php -v">
            <button>Run</button>
            </form>
            <pre>{output}</pre>
            """
        app.run(host="0.0.0.0", port=8080)
        EOF

    - name: Start server
      run: |
        python3 app.py &

    - name: Install cloudflared
      run: |
        wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
        chmod +x cloudflared-linux-amd64
        sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared

    - name: Start Cloudflare Tunnel
      run: |
        cloudflared tunnel --url http://localhost:8080 --no-autoupdate
